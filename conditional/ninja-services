<?php

// === CONDITIONAL INJECTION BASED ON PATH ===

function should_inject_lang_script() {
    $language_pairs = array(
        // English -> German
        '/about-me' => '/ueber-mich',
        '/about-me/contact' => '/ueber-mich/kontakt',
        '/professional' => '/berufswelt',
        '/professional/my-background' => '/berufswelt/mein-hintergrund',
        '/professional/my-background/my-competencies' => '/berufswelt/mein-hintergrund/meine-kompetenzen',
        '/professional/my-background/my-traits' => '/berufswelt/mein-hintergrund/meine-eigenschaften',
        '/professional/my-compass' => '/berufswelt/mein-kompass',
        '/professional/my-publications' => '/berufswelt/meine-publikationen',
        '/professional/my-availability' => '/berufswelt/meine-verfuegbarkeit'
    );
    
    // Create a flat array of all valid paths (English + German)
    $all_valid_paths = array_merge(array_keys($language_pairs), array_values($language_pairs));
    
    // Remove trailing slashes from all paths
    $all_valid_paths = array_map(function($p) {
        return rtrim($p, '/');
    }, $all_valid_paths);
    
    $request_uri = isset($_SERVER['REQUEST_URI']) ? wp_unslash($_SERVER['REQUEST_URI']) : '';
    $current_path = parse_url($request_uri, PHP_URL_PATH);
    $current_path = rtrim($current_path, '/');
    
    return in_array($current_path, $all_valid_paths, true);
}

// === EARLY AUTO-DETECTION (runs before page renders) ===

add_action('wp_head', function() {
    if (!should_inject_lang_script()) {
        return;
    }
    ?>
    <script>
        (function() {
            'use strict';
            
            // Check if user has already made a language choice
            const storedLanguage = localStorage.getItem('userLanguageChoice');
            if (storedLanguage) return; // Don't auto-redirect if user has made a choice
            
            // Get browser language (first preference)
            const browserLang = navigator.language || navigator.languages?.[0] || '';
            const langCode = browserLang.toLowerCase().split('-')[0];
            
            // Get current page info
            const currentPath = window.location.pathname.replace(/\/$/, '');
            
            // Define language pairs - English path maps to German path
            const languagePairs = {
                '/about-me': '/ueber-mich',
                '/about-me/contact': '/ueber-mich/kontakt',
                '/professional': '/berufswelt',
                '/professional/my-background': '/berufswelt/mein-hintergrund',
                '/professional/my-background/my-competencies': '/berufswelt/mein-hintergrund/meine-kompetenzen',
                '/professional/my-background/my-traits': '/berufswelt/mein-hintergrund/meine-eigenschaften',
                '/professional/my-compass': '/berufswelt/mein-kompass',
                '/professional/my-publications': '/berufswelt/meine-publikationen',
                '/professional/my-availability': '/berufswelt/meine-verfuegbarkeit'
            };
            
            // Create reverse mapping (German -> English)
            const reversePairs = {};
            Object.entries(languagePairs).forEach(([en, de]) => {
                reversePairs[de] = en;
            });
            
            // Determine if we're on English or German page
            const isOnEnglishPage = languagePairs.hasOwnProperty(currentPath);
            const isOnGermanPage = reversePairs.hasOwnProperty(currentPath);
            
            // Auto-redirect logic
            if (langCode === 'de' && isOnEnglishPage) {
                // Browser is German but on English page, redirect to German
                const germanPath = languagePairs[currentPath];
                if (germanPath) {
                    window.location.replace(germanPath);
                    return;
                }
            } else if (langCode === 'en' && isOnGermanPage) {
                // Browser is English but on German page, redirect to English
                const englishPath = reversePairs[currentPath];
                if (englishPath) {
                    window.location.replace(englishPath);
                    return;
                }
            }
            
            // Fallback for unrecognized languages: default to English if on German page
            if (!['de', 'en'].includes(langCode) && isOnGermanPage) {
                const englishPath = reversePairs[currentPath];
                if (englishPath) {
                    window.location.replace(englishPath);
                }
            }
        })();
    </script>
    <?php
}, 1);

// === FOOTER SCRIPTS & STYLES (CONDITIONAL) ===

add_action('wp_footer', function() {
    
    // === SCRIPT + STYLE INJECTION (for flag switcher) ===
    
    if (should_inject_lang_script()) {
        ?>
        <script>
            (function() {
                'use strict';
                let isProcessing = false;
                
                document.addEventListener('DOMContentLoaded', function() {
                    try {
                        document.body.classList.add('lang-ready');
                        
                        document.querySelectorAll('.lang-flag').forEach(function(flag) {
                            flag.addEventListener('click', function(e) {
                                e.preventDefault();
                                if (isProcessing) return;
                                
                                const target = flag.getAttribute('data-target');
                                if (target) {
                                    isProcessing = true;
                                    
                                    // Store user's manual language choice
                                    try {
                                        // Determine language based on target URL
                                        const germanPaths = ['/ueber-mich', '/berufswelt'];
                                        const isGermanTarget = germanPaths.some(path => target.includes(path));
                                        const targetLang = isGermanTarget ? 'de' : 'en';
                                        localStorage.setItem('userLanguageChoice', targetLang);
                                    } catch (error) {
                                        console.warn('Could not store language preference:', error);
                                    }
                                    
                                    window.location.href = target;
                                }
                            });
                            
                            flag.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    flag.click();
                                }
                            });
                        });
                    } catch (error) {
                        console.warn('Language switcher initialization failed:', error);
                    }
                });
            })();
        </script>
        <style>
            .ct-container-full .entry-content {position: relative;}
            .lang-flag-wrapper {position: relative; margin-top: -50px; padding-bottom: 20px; display: flex; justify-content: flex-end; visibility: hidden;}
            body.lang-ready .lang-flag-wrapper {visibility: visible;}
            .lang-flag {cursor: pointer; width: 36px; height: 20px; object-fit: cover; border: none; outline: none; transition: transform 0.2s ease;}
            .lang-flag:focus {outline: 1px solid #1e73be; outline-offset: 1px; box-shadow: 0 0 0 0.05rem rgba(0,123,255,0.25);}
            .lang-flag:hover {transform: scale(1.05);}
            .lang-flag:active {transform: scale(0.95);}
        </style>
        <?php
    }
    
    // === NINJA CHARACTER INJECTION ===
    
    if (
        is_page(array(
            // English Pages
            '179','87873','59078','55867','138768','113713','123635','65752','8977','100674','83147','55706','65756','87873','151412',
            // German Pages
            '150455','150449','149904','149998','150034','150120','150200','150223','150233','151417')) ||
        is_single(array(
            // English Singles
            '140909', '127567', '127484', '121987', '121984', '141168','121985', '135495', '121986', '121983','150592',
            // German Singles
            '150592')) ||
        is_tax('topics', 124)
    ) {
        ?>
        <script>
        (function() {
            const initNinja = function() {
                const targetContainer = document.querySelector(".hero-section[data-type='type-2'] > .entry-header.ct-container");
                if (targetContainer) {
                    const wrapper = document.createElement("div");
                    wrapper.className = "custom-ninja-wrapper";
                    wrapper.setAttribute("role", "img");
                    wrapper.setAttribute("aria-label", "Illustration of a Ninja Character");
                    const link = document.createElement("a");
                    link.href = "https://ericroth.org/services/";
                    link.style.pointerEvents = "auto";
                    link.title = "Ninja Services";
                    link.setAttribute("aria-label", "Visit Ninja Services Page");
                    link.setAttribute("role", "link");
                    link.setAttribute("tabindex", "0");
                    const img = document.createElement("img");
                    img.src = "https://ericroth.org/wp-content/uploads/2025/08/Ninja-Character-Stroke-1px.png";
                    img.alt = "Ninja Character Illustration";
                    img.className = "custom-ninja-image daneden-slideInRight";
                    img.width = 100;
                    img.height = 100;
                    img.loading = "lazy";
                    img.decoding = "async";
                    img.setAttribute("fetchpriority", "low");
                    link.appendChild(img);
                    wrapper.appendChild(link);
                    targetContainer.appendChild(wrapper);
                }
            };
            if ('requestIdleCallback' in window) {
                requestIdleCallback(initNinja);
            } else {
                window.addEventListener("load", initNinja);
            }
        })();
        </script>
        <style>
        .custom-ninja-wrapper {
            position: absolute;
            top: calc(50% - 25px);
            right: 25px;
            transform: translateY(-50%);
            z-index: 99;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .custom-ninja-image {
            max-width: 100%;
            height: auto;
            border: 0;
        }
        @media (min-width: 1200px) {.entry-header.ct-container .page-description p {margin-right: 150px;}}
        @media (max-width: 1200px) {.entry-header.ct-container .page-description p {margin-right: 140px;}}
        @media (max-width: 1024px) {.custom-ninja-wrapper {width: 90px; height: 90px;} .entry-header.ct-container .page-description p {margin-right: 130px;}}
        @media (max-width: 992px) {.custom-ninja-wrapper {width: 80px; height: 80px;} .entry-header.ct-container .page-description p {margin-right: 120px;}}
        @media (max-width: 768px) {.custom-ninja-wrapper {width: 70px; height: 70px;}}
        @media (max-width: 480px) {.custom-ninja-wrapper {width: 60px; height: 60px;}}
        </style>
        <?php
    }
    
});
